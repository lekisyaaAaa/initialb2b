# VermiLinks Home Assistant configuration (drop into configuration.yaml or !include it)
# - ESP32 nodes now post directly to the backend webhook; these entries are just for UI + manual control.
# - Forces legacy MQTT template processing so YAML-defined sensors/switches continue to work.
# - Make sure the ESP32 sketches publish/subscribe with the exact topics referenced below.

mqtt:
  broker: 192.168.8.142
  port: 1883
  client_id: vermilinks-ha-bridge
  username: knights_iot
  password: smbcr-5540
  keepalive: 60
  discovery: true
  discovery_prefix: homeassistant
  legacy_templates: true        # <— forces legacy YAML behavior that HA 2023.6+ hides behind the UI toggle
  enable_logger: true
  birth_message:
    topic: vermilinks/ha/status
    payload: online
    qos: 1
    retain: false
  will_message:
    topic: vermilinks/ha/status
    payload: offline
    qos: 1
    retain: false

sensor:
  - platform: mqtt
    name: "Vermi Temperature"
    unique_id: vermilinks_temperature_c
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    value_template: "{{ value_json.temperature | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi Humidity"
    unique_id: vermilinks_humidity_percent
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "%"
    device_class: humidity
    state_class: measurement
    value_template: "{{ value_json.humidity | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi Moisture"
    unique_id: vermilinks_moisture_percent
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "%"
    state_class: measurement
    value_template: "{{ value_json.moisture | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi EC"
    unique_id: vermilinks_ec_mscm
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "mS/cm"
    state_class: measurement
    value_template: "{{ value_json.ec | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi pH"
    unique_id: vermilinks_ph
    state_topic: "vermilinks/esp32b/metrics"
    state_class: measurement
    value_template: "{{ value_json.ph | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi Nitrogen"
    unique_id: vermilinks_nitrogen_ppm
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "ppm"
    state_class: measurement
    value_template: "{{ value_json.npk.n | default(value_json.nitrogen, true) | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi Phosphorus"
    unique_id: vermilinks_phosphorus_ppm
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "ppm"
    state_class: measurement
    value_template: "{{ value_json.npk.p | default(value_json.phosphorus, true) | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi Potassium"
    unique_id: vermilinks_potassium_ppm
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "ppm"
    state_class: measurement
    value_template: "{{ value_json.npk.k | default(value_json.potassium, true) | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"
  - platform: mqtt
    name: "Vermi RSSI"
    unique_id: vermilinks_signal_dbm
    state_topic: "vermilinks/esp32b/metrics"
    unit_of_measurement: "dBm"
    icon: mdi:wifi
    value_template: "{{ value_json.signal | default(value_json.signalStrength) | float(0) }}"
    availability_topic: "vermilinks/esp32b/status"
    payload_available: "online"
    payload_not_available: "offline"

switch:
  - platform: mqtt
    name: "Vermi Water Pump"
    unique_id: vermilinks_pump
    command_topic: "vermilinks/esp32a/pump"
    state_topic: "vermilinks/esp32a/state"
    value_template: "{{ 'ON' if value_json.pump else 'OFF' }}"
    payload_on: "ON"
    payload_off: "OFF"
    qos: 1
    retain: false
  - platform: mqtt
    name: "Vermi Solenoid Zone 1"
    unique_id: vermilinks_solenoid_zone_1
    command_topic: "vermilinks/esp32a/valve1"
    state_topic: "vermilinks/esp32a/state"
    value_template: "{{ 'ON' if value_json.valve1 else 'OFF' }}"
    payload_on: "ON"
    payload_off: "OFF"
    qos: 1
    retain: false
  - platform: mqtt
    name: "Vermi Solenoid Zone 2"
    unique_id: vermilinks_solenoid_zone_2
    command_topic: "vermilinks/esp32a/valve2"
    state_topic: "vermilinks/esp32a/state"
    value_template: "{{ 'ON' if value_json.valve2 else 'OFF' }}"
    payload_on: "ON"
    payload_off: "OFF"
    qos: 1
    retain: false
  - platform: mqtt
    name: "Vermi Solenoid Zone 3"
    unique_id: vermilinks_solenoid_zone_3
    command_topic: "vermilinks/esp32a/valve3"
    state_topic: "vermilinks/esp32a/state"
    value_template: "{{ 'ON' if value_json.valve3 else 'OFF' }}"
    payload_on: "ON"
    payload_off: "OFF"
    qos: 1
    retain: false

binary_sensor:
  - platform: mqtt
    name: "Vermi Reservoir Low"
    unique_id: vermilinks_reservoir_low
    device_class: problem
    state_topic: "vermilinks/esp32a/state"
    value_template: >-
      {% set raw = value_json.floatSensor | default(value_json.float_state | default(value_json.float)) %}
      {% if raw in ['DRY', 'dry', 'LOW', 'low'] %}
        ON
      {% elif raw in ['WET', 'wet', 'HIGH', 'high'] %}
        OFF
      {% elif raw in [1, '1', true] %}
        ON
      {% else %}
        OFF
      {% endif %}
    payload_on: "ON"
    payload_off: "OFF"
    availability_topic: "vermilinks/esp32a/status"
    payload_available: "online"
    payload_not_available: "offline"

# Mirror the MQTT switch state into template binary_sensors that the backend watches
template:
  - binary_sensor:
      - name: "vermi_water_pump"
        unique_id: vermilinks_template_pump
        device_class: running
        state: "{{ is_state('switch.vermilinks_pump', 'on') }}"
      - name: "vermi_solenoid_1"
        unique_id: vermilinks_template_solenoid_1
        state: "{{ is_state('switch.vermilinks_solenoid_zone_1', 'on') }}"
      - name: "vermi_solenoid_2"
        unique_id: vermilinks_template_solenoid_2
        state: "{{ is_state('switch.vermilinks_solenoid_zone_2', 'on') }}"
      - name: "vermi_solenoid_3"
        unique_id: vermilinks_template_solenoid_3
        state: "{{ is_state('switch.vermilinks_solenoid_zone_3', 'on') }}"

automation:
  - alias: "Publish float sensor heartbeat"
    id: vermilinks_float_heartbeat
    trigger:
      - platform: time_pattern
        minutes: "/5"
    action:
      - service: mqtt.publish
        data:
          topic: "vermilinks/ha/heartbeat"
          payload: "{\"device\":\"vermilinks-ha\",\"ts\":\"{{ now().isoformat() }}\"}"
          qos: 0
          retain: false
